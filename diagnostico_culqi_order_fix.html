<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico: Error de Culqi - Order</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .error { background-color: #ffebee; border-left: 4px solid #f44336; }
        .fix { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        .warning { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .info { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; border-radius: 4px; }
        .step { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üö® Diagn√≥stico: Error de Culqi - "order" must be one of [number, string]</h1>
    
    <div class="section error">
        <h2>‚ùå Problema Identificado</h2>
        <p><strong>Error:</strong> <code>ValidationError: "order" must be one of [number, string]</code></p>
        <p><strong>Causa:</strong> El campo "order" est√° llegando como <code>null</code> o <code>undefined</code> a Culqi.settings()</p>
        <p><strong>Raz√≥n principal:</strong> Los precios del carrito est√°n en 0, por lo que totalPrice = 0 y no se genera la orden.</p>
    </div>

    <div class="section fix">
        <h2>‚úÖ Correcciones Aplicadas</h2>
        
        <div class="step">
            <h3>1. Corregido el problema de precios en CarritoContext.jsx</h3>
            <p>‚úÖ La funci√≥n <code>actualizarPrecios</code> ahora maneja correctamente las variaciones</p>
            <p>‚úÖ Cada variaci√≥n obtiene su precio espec√≠fico del backend</p>
        </div>
        
        <div class="step">
            <h3>2. Corregido el c√°lculo de totalPrice en Checkout.jsx</h3>
            <p>‚úÖ Ahora usa <code>v.final_price</code> para cada variaci√≥n en lugar de <code>item.final_price</code></p>
            <p>‚úÖ Agregadas validaciones de seguridad para precios null/undefined</p>
        </div>
        
        <div class="step">
            <h3>3. Agregadas validaciones robustas en onCulqiOpen</h3>
            <p>‚úÖ Validaci√≥n de carrito no vac√≠o</p>
            <p>‚úÖ Validaci√≥n de totalPrice > 0</p>
            <p>‚úÖ Validaci√≥n de precios v√°lidos en productos</p>
            <p>‚úÖ Validaci√≥n de respuesta exitosa del backend</p>
            <p>‚úÖ Validaci√≥n de order_number antes de pasarlo a Culqi</p>
        </div>
        
        <div class="step">
            <h3>4. Agregados logs de debug</h3>
            <p>‚úÖ Console.log para rastrear el flujo de creaci√≥n de orden</p>
            <p>‚úÖ Informaci√≥n detallada en consola para diagnosticar problemas</p>
        </div>
    </div>

    <div class="section info">
        <h2>üîç Pasos para Verificar la Soluci√≥n</h2>
        
        <div class="step">
            <h3>Paso 1: Limpiar y probar</h3>
            <ol>
                <li>Abre la consola del navegador (F12)</li>
                <li>Limpia el localStorage: <code>localStorage.clear()</code></li>
                <li>Recarga la p√°gina completamente (Ctrl+F5)</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>Paso 2: Agregar productos al carrito</h3>
            <ol>
                <li>Ve a un producto (ej: ShakerCup)</li>
                <li>Selecciona un color y agrega al carrito</li>
                <li>Verifica en la consola que se ejecute la funci√≥n actualizarPrecios</li>
                <li>Verifica que los precios NO sean 0 en el carrito del header</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>Paso 3: Verificar en checkout</h3>
            <ol>
                <li>Ve al checkout</li>
                <li>Verifica que el subtotal NO sea S/ 0.00</li>
                <li>Llena todos los campos requeridos</li>
                <li>Haz clic en "Realizar el pedido"</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>Paso 4: Verificar logs de Culqi</h3>
            <p>En la consola deber√≠as ver:</p>
            <pre>
üöÄ Creando orden Culqi: { totalPrice: XX.XX, cart: [...], saleData: {...} }
üìã Respuesta de Culqi: { data: { id: "ord_xxx", order_number: "#WF-xxx" } }
‚úÖ Orden creada exitosamente: ord_xxx
            </pre>
        </div>
    </div>

    <div class="section warning">
        <h2>‚ö†Ô∏è Si Persiste el Problema</h2>
        
        <div class="step">
            <h3>Verificar Backend</h3>
            <ol>
                <li>Revisa los logs de Laravel: <code>storage/logs/laravel.log</code></li>
                <li>Verifica que el endpoint <code>/api/items/verify-stock</code> devuelva precios</li>
                <li>Verifica que <code>/api/culqi/order</code> funcione correctamente</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>Verificar Configuraci√≥n de Culqi</h3>
            <ol>
                <li>Verifica las variables de entorno: <code>CULQI_PRIVATE_KEY</code>, <code>CULQI_API</code></li>
                <li>Verifica que la configuraci√≥n de Culqi en el frontend est√© correcta</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>Debug Manual</h3>
            <p>En la consola del navegador, ejecuta:</p>
            <pre>
// Verificar carrito
console.log('Carrito:', JSON.parse(localStorage.getItem('carrito')));

// Verificar que los productos tengan precios
const cart = JSON.parse(localStorage.getItem('carrito'));
cart.forEach(item => {
    console.log('Item:', item.name, 'Precio:', item.final_price);
    if (item.variations) {
        item.variations.forEach(v => {
            console.log('  Variaci√≥n:', v.color, v.size, 'Precio:', v.final_price);
        });
    }
});
            </pre>
        </div>
    </div>

    <div class="section info">
        <h2>üìã Resultado Esperado</h2>
        <p>Despu√©s de estas correcciones:</p>
        <ul>
            <li>‚úÖ Los precios en el carrito deben ser mayores a 0</li>
            <li>‚úÖ El totalPrice en checkout debe ser mayor a 0</li>
            <li>‚úÖ Se debe generar correctamente la orden en Culqi</li>
            <li>‚úÖ El campo "order" debe llegar como string a Culqi.settings()</li>
            <li>‚úÖ No debe aparecer el error de validaci√≥n</li>
        </ul>
    </div>
</body>
</html>
